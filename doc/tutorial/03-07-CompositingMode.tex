\subsection{コンポジティングモード}

ピクセル単位のコンポジット方法はCompositingModeクラスで設定します。
ここで制御できるのは、デプステスト、αテスト、フレームバッファーへの書き込みおよびブレンド方法、デプスオフセットです。
M3Gはステンシルバッファー、アキュムレーションバッファーには対応していません。


\subsubsection{デプステスト}
setDepthTestEnable()メソッドはデプステストを有効化・無効化します。
デプスバッファーそのものが有効化されていないときは無視されます。
デフォルトはenable=trueです。

\begin{verbatim}
void 	setDepthTestEnable (bool enable)
\end{verbatim}

M3Gではデプステストは常にOpenGLで言うLEQUALです。
つまりｚ値がデプスバッファーの値より小さい（手前にある）時、デプステストを通過します。

現在のデプステストの有効・無効はisDepthTestEnabled()メソッドで取得できます。

\begin{verbatim}
bool 	isDepthTestEnabled () const
\end{verbatim}


\subsubsection{αテスト}

setAlphatThreashold()メソッドはフラグメントのαテストの閾値を指定します。
デフォルトはthreshold=0.0です。

\begin{verbatim}
void 	setAlphaThreshold (float threshold)
\end{verbatim}

M3Gではαテストは常にOpenGLで言うGEQUALです。
つまりフラグメントのα値がthreashold以上の時テストを通過します。
指定したthresholdより小さいαを持つフラグメントはフレームバッファーに書き込まれることなく棄却されます。
threshold=0を指定するとαテストそのものを無効化できます。

現在の閾値はgetAlphaThreshold()メソッドで取得できます。

\begin{verbatim}
float 	getAlphaThreshold () const
\end{verbatim}

\subsubsection{デプスバッファーへの書き込み}

setDepthWriteEnable()メソッドでデプスバッファーへの書き込みを制御します。

\begin{verbatim}
void 	setDepthWriteEnable (bool enable)
\end{verbatim}

デフォルトはenable=trueです。
enable=falseの時デプスバッファーへの書き込みは行われません。
このメソッドはデプステストが行われるかどうかには関与しません。
典型的には半透明物体の書き込み時にオフにされます。

現在のデプスバッファーへの書き込みの可否はisDepthWriteEnabled()メソッドで取得できます。

\begin{verbatim}
bool 	isDepthWriteEnabled () const 
\end{verbatim}

\subsubsection{カラーコンポーネントへの書き込み}
setColorWriteEnable()メソッドでフレームバッファーのカラーコンポーネントへの書き込みを制御します。

\begin{verbatim}
void 	setColorWriteEnable (bool enable)
\end{verbatim}

カラーコンポーネントはr,g,bの３チャネル同時に制御し、チャネル毎に個別に制御する事はできません。
αチャネルには影響しません。

現在のカラーコンポーネントへの書き込みの可否はisColorWriteEnalbed()メソッドで取得します。

\begin{verbatim}
bool 	isColorWriteEnabled () const
\end{verbatim}

\subsubsection{αコンポーネントへの書き込み}
setAlphaWriteEnable()メソッドでフレームバッファーαコンポーネントへの書き込みを制御します。
カラーコンポーネントには影響しません。

\begin{verbatim}
void 	setAlphaWriteEnable (bool enable)
\end{verbatim}

現在のαコンポーネントへの書き込みの可否はisAlphaWriteEnalbed()メソッドで取得します。

\begin{verbatim}
bool 	isAlphaWriteEnabled () const
\end{verbatim}


\subsubsection{ブレンディング方法}

フラグメントをフレームバッファーへ書き込むときの演算方法を制御します。

\begin{verbatim}
void 	setBlending (int mode)
\end{verbatim}

引数のmodeにはREPLACE, ALPHA, ALPHA\_ADD, MODULATE, MODULATE\_x2の中から1つを選択します。
フラグメントを$C_s = (R_s, G_s, B, s, A_s)$、既存のフレームバッファーを$C_d = (R_d, G_d, B_d, A_d)$とするとブレンド後のフレームバッファーの値は下記の通りになします。

\begin{tabular}{ll}
  REPLACE      & $ C_d = C_s         $        \\ 
  ALPHA        & $ C_d = C_sA_s + C_d $        \\ 
  ALPHA\_ADD   & $ C_d = C_sA_s + C_d(1-A_s) $ \\ 
  MODULATE     & $ C_d = C_sC_d      $        \\ 
  MODULATE\_x2 & $ C_d = 2 C_sC_d    $

\end{tabular}

現在のブレンディングモードはgetBlending()メソッドで取得できます。

\begin{verbatim}
int 	getBlending () const
\end{verbatim}

\subsubsection{デプスオフセット}

setDepthOffset()メソッドでデプスオフセットの設定を行います。
デプスオフセットはデプスバッファーの有限の精度から生じる問題を解消するために、
ｚ値にごくわずかなオフセットを足します。

\begin{verbatim}
void 	setDepthOffset (float factor, float units)
\end{verbatim}

下記の式を使って引数のfactorとunitsから最終的なオフセット量を計算します。

\[ offset = m \cdot factor + r \cdot units \]

rはデプスバッファーの最小精度で、mはトライアングルのｚ方向の最大勾配です。

現在のデプスオフセットの設定はgetDepthOffsetFactor()メソッドとgetDepthOffsetUnits()メソッドで取得します。

\begin{verbatim}
float 	getDepthOffsetFactor () const
float 	getDepthOffsetUnits () const
\end{verbatim}
